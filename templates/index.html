<!DOCTYPE html>
<html>

<head>
    <title>TripHobo AI Travel Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'triphobo-blue': '#0f4c75',
                        'triphobo-light': '#3282b8',
                        'triphobo-green': '#52c41a'
                    }
                }
            }
        }
    </script>
    <style>
        .avatar-container {
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .avatar-slide-left {
            transform: translateX(-120px);
        }

        .photo-gallery {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%) translateX(100%);
            width: 240px;
            opacity: 0;
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .photo-gallery.active {
            transform: translateY(-50%) translateX(0);
            opacity: 1;
        }

        .photo-card {
            display: none;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .photo-card.active {
            display: block;
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .avatar-photo-container {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            min-height: 300px;
        }

        .map-panel {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            transform: translateY(-20px);
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            height: 0;
        }

        .map-panel.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
            height: 400px;
        }

        .map-content {
            height: 350px;
            width: 100%;
        }

        .map-toggle-btn {
            background: linear-gradient(135deg, #0f4c75, #3282b8);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .map-toggle-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(15, 76, 117, 0.3);
        }

        .map-toggle-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .destination-marker {
            animation: markerPop 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes markerPop {
            0% {
                transform: scale(0);
            }

            50% {
                transform: scale(1.2);
            }

            100% {
                transform: scale(1);
            }
        }

        .route-info {
            background: linear-gradient(135deg, #0f4c75, #3282b8);
            color: white;
            padding: 20px;
            position: relative;
        }

        .destination-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .destination-tag {
            background: rgba(255, 255, 255, 0.2);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.875rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .close-map-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .close-map-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .mumbai-marker {
            background: linear-gradient(135deg, #0f4c75, #3282b8);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 10px;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-triphobo-blue via-triphobo-light to-triphobo-blue min-h-screen">
    <!-- Header -->
    <header class="bg-white/95 backdrop-blur-sm shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <span class="text-2xl">üèùÔ∏è</span>
                <h1 class="text-2xl font-bold text-triphobo-blue">TripHobo AI</h1>
            </div>
            <div class="flex space-x-4">
                <button
                    class="px-4 py-2 border-2 border-triphobo-blue text-triphobo-blue rounded-lg hover:bg-triphobo-blue hover:text-white transition-all">
                    Log in
                </button>
                <button class="px-4 py-2 bg-triphobo-green text-white rounded-lg hover:bg-green-600 transition-all">
                    Sign up
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto p-6">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 h-[calc(100vh-120px)]">
            <!-- Left Side - Avatar & Controls -->
            <div class="bg-white rounded-2xl shadow-2xl p-8 flex flex-col items-center justify-center relative">
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-bold text-triphobo-blue mb-4">Hi, I'm Maya!</h2>
                    <p class="text-gray-600 text-lg">Your AI travel planning assistant from Mumbai</p>
                </div>
                <!-- Avatar and Photo Gallery Container -->
                <div class="avatar-photo-container">
                    <div id="avatar-container" class="avatar-container z-10">
                        <img id="avatar" src="/static/img/avatar_static_2.png" alt="Maya AI Assistant"
                            class="w-48 h-48 rounded-full border-4 border-triphobo-green shadow-xl object-cover hover:scale-105 transition-transform">
                    </div>
                    <div id="photo-gallery" class="photo-gallery z-20">
                        <!-- Photos will be dynamically inserted here -->
                    </div>
                </div>
                <!-- Controls -->
                <div class="flex flex-col space-y-4 w-full max-w-sm mt-8">
                    <button id="startBtn" onclick="startCall()"
                        class="bg-gradient-to-r from-triphobo-green to-green-500 text-white font-semibold py-4 px-8 rounded-full shadow-lg hover:shadow-xl hover:scale-105 transition-all">
                        üéôÔ∏è Start Conversation
                    </button>
                    <button id="stopBtn" onclick="stopCall()" disabled
                        class="bg-gradient-to-r from-red-500 to-red-600 text-white font-semibold py-4 px-8 rounded-full shadow-lg hover:shadow-xl hover:scale-105 transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100">
                        ‚èπÔ∏è Stop Conversation
                    </button>
                </div>
                <!-- Status -->
                <div id="status"
                    class="mt-6 px-6 py-3 rounded-full font-semibold text-center w-full max-w-sm bg-red-100 text-red-800 border border-red-200">
                    Ready to help you plan your adventure from Mumbai
                </div>
                <!-- Debug Toggle -->
                <button onclick="toggleDebug()" class="mt-6 text-sm text-gray-500 hover:text-gray-700 underline">
                    Toggle Debug Logs
                </button>
            </div>

            <!-- Right Side - Map & Conversation -->
            <div class="flex flex-col">
                <!-- Map Toggle Button -->
                <button id="map-toggle-btn" class="map-toggle-btn" onclick="toggleMap()" disabled>
                    üó∫Ô∏è Show Travel Map
                </button>

                <!-- Map Panel (Hidden by default) -->
                <div id="map-panel" class="map-panel">
                    <!-- Map Header -->
                    <div class="route-info">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-semibold text-lg">üó∫Ô∏è Your Journey from Mumbai</span>
                            <div class="flex gap-2">
                                <button onclick="clearRoute()"
                                    class="text-sm bg-white/20 px-3 py-1 rounded-full hover:bg-white/30 transition-all border border-white/30">
                                    Clear Route
                                </button>
                                <button class="close-map-btn" onclick="hideMap()">‚úï</button>
                            </div>
                        </div>
                        <div id="destination-list" class="destination-list">
                            <div class="destination-tag">üìç Starting from Mumbai</div>
                        </div>
                        <div class="mt-3 text-sm opacity-90">
                            <span id="route-stats">Tell me your destinations and watch your route appear!</span>
                        </div>
                    </div>
                    <!-- Map Content -->
                    <div id="map" class="map-content"></div>
                </div>

                <!-- Conversation -->
                <div class="bg-white rounded-2xl shadow-2xl flex flex-col overflow-hidden flex-1">
                    <!-- Chat Header -->
                    <div class="bg-gradient-to-r from-triphobo-blue to-triphobo-light text-white p-6">
                        <h3 class="text-xl font-bold flex items-center">
                            üí¨ Conversation with Maya
                        </h3>
                    </div>
                    <!-- Chat Messages -->
                    <div class="flex-1 overflow-y-auto p-6 bg-gray-50" id="transcript-container"
                        style="max-height: 400px;">
                        <div id="transcript" class="space-y-4">
                            <div class="chat-message assistant flex justify-start">
                                <div
                                    class="message-bubble max-w-xs lg:max-w-md px-4 py-3 rounded-2xl rounded-bl-md bg-white border border-gray-200 shadow-sm">
                                    <div class="message-header text-xs font-semibold text-triphobo-green mb-1">Maya
                                    </div>
                                    <div class="message-text text-sm text-gray-800">Hi there! I'm here in Mumbai and
                                        ready to help you plan your journey. Click "Start Conversation" and tell me
                                        where you'd like to go! üåü</div>
                                    <div class="message-time text-xs text-gray-500 mt-2">Ready to start</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Debug Logs -->
        <div id="debugLogs"
            class="hidden mt-6 bg-black text-green-400 p-4 rounded-lg font-mono text-sm max-h-64 overflow-y-auto"></div>
    </div>

    <script type="module">
        let socket;
        let audioContext;
        let micStream;
        let showDebug = false;
        let outputWorkletNode;
        let inputWorkletNode;
        let assistantSpeakingTimeout;
        let isAssistantSpeaking = false;
        let currentDestinations = new Set();
        let photoCycleInterval;
        let currentPhotos = [];
        let currentPhotoIndex = 0;
        let photoDisplayTimeout;

        // Map variables
        let map;
        let destinationMarkers = [];
        let routeLines = [];
        let routeDestinations = [];
        let mumbaiMarker;
        let mapInitialized = false;
        let firstDestinationAdded = false;

        // Mumbai coordinates
        const MUMBAI_COORDS = [19.0760, 72.8777];

        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const statusEl = document.getElementById('status');
        const transcriptEl = document.getElementById('transcript');
        const transcriptContainer = document.getElementById('transcript-container');
        const debugLogsEl = document.getElementById('debugLogs');
        const photoGallery = document.getElementById('photo-gallery');
        const avatarContainer = document.getElementById('avatar-container');
        const mapOverlay = document.getElementById('map-panel');
        const mapToggleBtn = document.getElementById('map-toggle-btn');
        const destinationListEl = document.getElementById('destination-list');
        const routeStatsEl = document.getElementById('route-stats');

        const avatarImg = document.getElementById('avatar');
        const animatedAvatarSrc = "/static/img/avatar3.gif";
        const staticAvatarSrc = "/static/img/avatar_static_2.png";

        if (avatarImg) {
            avatarImg.src = staticAvatarSrc;
        }

        // Initialize map (but don't show it yet)
        function initializeMap() {
            if (mapInitialized) return;

            map = L.map('map', {
                zoomControl: true,
                scrollWheelZoom: true,
                dragging: true
            }).setView(MUMBAI_COORDS, 6);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 18
            }).addTo(map);

            // Add Mumbai marker
            const mumbaiIcon = L.divIcon({
                html: `<div class="mumbai-marker">üè†</div>`,
                className: 'custom-marker',
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            });

            mumbaiMarker = L.marker(MUMBAI_COORDS, { icon: mumbaiIcon }).addTo(map);
            mumbaiMarker.bindPopup(`
                <div style="text-align: center; min-width: 150px;">
                    <strong style="color: #0f4c75;">Mumbai</strong><br>
                    <small style="color: #666;">Your Starting Point</small><br>
                    <div style="margin-top: 8px; padding: 4px 8px; background: #f0f9ff; border-radius: 4px; font-size: 11px;">
                        üè† Home Base
                    </div>
                </div>
            `);

            mapInitialized = true;
            debugLog("Map initialized with Mumbai as starting point");
        }

        // Show map panel with animation
        function showMap() {
            if (!mapInitialized) {
                initializeMap();
            }
            mapOverlay.classList.add('active');
            mapToggleBtn.textContent = 'üó∫Ô∏è Hide Travel Map';
            // Invalidate map size after animation
            setTimeout(() => {
                map.invalidateSize();
            }, 500);
            debugLog("Map panel shown");
        }

        // Hide map panel
        function hideMap() {
            mapOverlay.classList.remove('active');
            mapToggleBtn.textContent = 'üó∫Ô∏è Show Travel Map';
            debugLog("Map panel hidden");
        }

        // Toggle map visibility
        function toggleMap() {
            if (mapOverlay.classList.contains('active')) {
                hideMap();
            } else {
                showMap();
            }
        }

        // Geocoding function to get coordinates from place names
        async function geocodeDestination(placeName) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(placeName)}&limit=1&addressdetails=1`);
                const data = await response.json();

                if (data && data.length > 0) {
                    const location = data[0];
                    return {
                        name: placeName,
                        displayName: location.display_name.split(',')[0],
                        lat: parseFloat(location.lat),
                        lng: parseFloat(location.lon),
                        country: location.address?.country || ''
                    };
                }
                return null;
            } catch (error) {
                debugLog('Geocoding error for ' + placeName, error);
                return null;
            }
        }

        // Add destination marker with animation
        function addDestinationMarker(destination) {
            const customIcon = L.divIcon({
                html: `<div class="destination-marker" style="
                    background: linear-gradient(135deg, #52c41a, #389e0d);
                    width: 24px;
                    height: 24px;
                    border-radius: 50%;
                    border: 3px solid white;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-weight: bold;
                    font-size: 12px;
                ">${routeDestinations.length + 1}</div>`,
                className: 'custom-marker',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });

            const marker = L.marker([destination.lat, destination.lng], {
                icon: customIcon
            }).addTo(map);

            marker.bindPopup(`
                <div style="text-align: center; min-width: 150px;">
                    <strong style="color: #0f4c75;">${destination.displayName}</strong><br>
                    <small style="color: #666;">${destination.country}</small><br>
                    <div style="margin-top: 8px; padding: 4px 8px; background: #f0f9ff; border-radius: 4px; font-size: 11px;">
                        Stop ${routeDestinations.length + 1} on your journey
                    </div>
                </div>
            `);

            destinationMarkers.push(marker);
            return marker;
        }

        // Draw animated route line with arrow
        function drawAnimatedRoute(fromCoords, toCoords) {
            const routePoints = [fromCoords, toCoords];

            // Create the route line with styling
            const routeLine = L.polyline([], {
                color: '#ff6b35',
                weight: 4,
                opacity: 0.8,
                lineCap: 'round',
                lineJoin: 'round'
            }).addTo(map);

            // Animate the line drawing
            let pointIndex = 0;
            const animationSpeed = 50;
            const totalPoints = 20;

            function interpolatePoints(start, end, steps) {
                const points = [];
                for (let i = 0; i <= steps; i++) {
                    const ratio = i / steps;
                    const lat = start[0] + (end[0] - start[0]) * ratio;
                    const lng = start[1] + (end[1] - start[1]) * ratio;
                    points.push([lat, lng]);
                }
                return points;
            }

            const interpolatedPoints = interpolatePoints(routePoints[0], routePoints[1], totalPoints);
            const animatedPoints = [];

            function animateLine() {
                if (pointIndex < interpolatedPoints.length) {
                    animatedPoints.push(interpolatedPoints[pointIndex]);
                    routeLine.setLatLngs(animatedPoints);
                    pointIndex++;
                    setTimeout(animateLine, animationSpeed);
                } else {
                    // Add arrow at the end
                    addArrowHead(routePoints[0], routePoints[1]);
                }
            }

            animateLine();
            routeLines.push(routeLine);
        }

        // Add arrow head at the end of route
        function addArrowHead(fromCoords, toCoords) {
            const bearing = calculateBearing(fromCoords[0], fromCoords[1], toCoords[0], toCoords[1]);

            const arrowIcon = L.divIcon({
                html: `<div style="
                    transform: rotate(${bearing}deg);
                    font-size: 20px;
                    text-shadow: 0 0 4px rgba(0,0,0,0.5);
                ">‚û§</div>`,
                className: 'arrow-marker',
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });

            const arrowMarker = L.marker(toCoords, { icon: arrowIcon }).addTo(map);
            routeLines.push(arrowMarker);
        }

        // Calculate bearing between two points for arrow direction
        function calculateBearing(lat1, lng1, lat2, lng2) {
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const y = Math.sin(dLng) * Math.cos(lat2 * Math.PI / 180);
            const x = Math.cos(lat1 * Math.PI / 180) * Math.sin(lat2 * Math.PI / 180) -
                Math.sin(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.cos(dLng);
            const bearing = Math.atan2(y, x) * 180 / Math.PI;
            return (bearing + 360) % 360;
        }

        // Update route information display
        function updateRouteInfo() {
            const destinationTags = routeDestinations.map((dest, index) =>
                `<div class="destination-tag">${index + 1}. ${dest.displayName}</div>`
            ).join('');

            destinationListEl.innerHTML = `
                <div class="destination-tag">üìç Starting from Mumbai</div>
                ${destinationTags}
            `;

            const stats = routeDestinations.length === 0 ?
                'Tell me your destinations and watch your route appear!' :
                routeDestinations.length === 1 ?
                    `1 destination added to your journey` :
                    `${routeDestinations.length} destinations on your route`;

            routeStatsEl.textContent = stats;
        }

        // Add destination to route
        async function addDestinationToRoute(destinationName) {
            try {
                // Check if destination already exists
                const existingDest = routeDestinations.find(dest =>
                    dest.name.toLowerCase() === destinationName.toLowerCase()
                );

                if (existingDest) {
                    debugLog(`Destination ${destinationName} already in route`);
                    return;
                }

                debugLog(`Geocoding destination: ${destinationName}`);
                const destination = await geocodeDestination(destinationName);

                if (!destination) {
                    debugLog(`Could not geocode: ${destinationName}`);
                    return;
                }

                // Show map if this is the first destination or if map is currently hidden
                if (!firstDestinationAdded) {
                    showMap();
                    firstDestinationAdded = true;
                    mapToggleBtn.disabled = false;
                } else if (!mapOverlay.classList.contains('active')) {
                    // If map is hidden but user mentions new destination, show it again
                    showMap();
                    debugLog("Map reopened due to new destination mentioned");
                }

                debugLog(`Adding destination to route`, destination);

                // Add marker
                const marker = addDestinationMarker(destination);

                // Draw route line from Mumbai (if first destination) or from last destination
                const fromCoords = routeDestinations.length === 0 ?
                    MUMBAI_COORDS :
                    [routeDestinations[routeDestinations.length - 1].lat, routeDestinations[routeDestinations.length - 1].lng];

                setTimeout(() => {
                    drawAnimatedRoute(fromCoords, [destination.lat, destination.lng]);
                }, 300);

                // Add to route
                routeDestinations.push(destination);

                // Update map view to fit all destinations including Mumbai
                const allMarkers = [mumbaiMarker, ...destinationMarkers];
                const group = new L.featureGroup(allMarkers);
                map.fitBounds(group.getBounds().pad(0.1));

                // Update route info display
                updateRouteInfo();

                debugLog(`Route now has ${routeDestinations.length} destinations`);

            } catch (error) {
                debugLog('Error adding destination to route', error);
            }
        }

        // Clear entire route
        function clearRoute() {
            // Remove all destination markers
            destinationMarkers.forEach(marker => map.removeLayer(marker));
            destinationMarkers = [];

            // Remove all route lines
            routeLines.forEach(line => map.removeLayer(line));
            routeLines = [];

            // Clear destinations
            routeDestinations = [];

            // Reset map view to Mumbai
            map.setView(MUMBAI_COORDS, 6);

            // Hide map and disable button
            hideMap();
            mapToggleBtn.disabled = true;
            firstDestinationAdded = false;

            // Update UI
            updateRouteInfo();

            debugLog("Route cleared");
        }

        window.updateStatus = function (message, connected = false) {
            statusEl.textContent = message;
            statusEl.className = `mt-6 px-6 py-3 rounded-full font-semibold text-center w-full max-w-sm ${connected ? 'bg-green-100 text-green-800 border-green-200' : 'bg-red-100 text-red-800 border-red-200'}`;
            startBtn.disabled = connected;
            stopBtn.disabled = !connected;
        }

        window.addToTranscript = async function (role, text, timestamp = null) {
            const chatMessage = document.createElement('div');
            chatMessage.className = `chat-message ${role} flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
            const messageBubble = document.createElement('div');
            messageBubble.className = `message-bubble max-w-xs lg:max-w-md px-4 py-3 rounded-2xl shadow-sm ${role === 'user' ? 'rounded-br-md bg-gradient-to-r from-blue-500 to-blue-600 text-white' : 'rounded-bl-md bg-white border border-gray-200'}`;
            const messageHeader = document.createElement('div');
            messageHeader.className = `message-header text-xs font-semibold mb-1 ${role === 'user' ? 'text-blue-100' : 'text-triphobo-green'}`;
            messageHeader.textContent = role === 'user' ? 'You' : 'Maya';
            const messageText = document.createElement('div');
            messageText.className = `message-text text-sm ${role === 'user' ? 'text-white' : 'text-gray-800'}`;
            messageText.textContent = text;
            const messageTime = document.createElement('div');
            messageTime.className = `message-time text-xs mt-2 ${role === 'user' ? 'text-blue-200' : 'text-gray-500'}`;
            messageTime.textContent = timestamp || new Date().toLocaleTimeString();
            messageBubble.appendChild(messageHeader);
            messageBubble.appendChild(messageText);
            messageBubble.appendChild(messageTime);
            chatMessage.appendChild(messageBubble);
            transcriptEl.appendChild(chatMessage);
            transcriptContainer.scrollTo({ top: transcriptContainer.scrollHeight, behavior: 'smooth' });

            // Process destinations for both user and assistant messages
            await fetchDestinations(text);
        }

        window.debugLog = function (message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            let logMessage = `[${timestamp}] ${message}`;
            if (data) {
                logMessage += '\n' + JSON.stringify(data, null, 2);
            }
            if (showDebug) {
                debugLogsEl.textContent += logMessage + '\n';
                debugLogsEl.scrollTop = debugLogsEl.scrollHeight;
            }
            console.log(logMessage, data);
        }

        window.toggleDebug = function () {
            showDebug = !showDebug;
            debugLogsEl.classList.toggle('hidden', !showDebug);
        }

        async function fetchDestinations(text) {
            try {
                const response = await fetch('/extract-destinations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text })
                });
                if (!response.ok) throw new Error('Failed to extract destinations');
                const { destinations } = await response.json();
                if (destinations.length > 0) {
                    debugLog('Extracted destinations', destinations);

                    // Add each new destination to the route
                    for (const destination of destinations) {
                        await addDestinationToRoute(destination);
                        // Small delay between adding destinations for better animation
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }

                    // Also handle photo gallery for the last destination
                    const latestDestination = destinations[destinations.length - 1];
                    if (!currentDestinations.has(latestDestination)) {
                        currentDestinations.clear();
                        currentDestinations.add(latestDestination);
                        await fetchPhotos(latestDestination);
                    }
                }
            } catch (error) {
                debugLog('Error fetching destinations', error);
            }
        }

        async function fetchPhotos(destination) {
            try {
                clearPhotoCycle();
                const response = await fetch(`/destination-photos/${encodeURIComponent(destination)}?count=5`);
                if (!response.ok) throw new Error('Failed to fetch photos');
                const { photos } = await response.json();
                if (photos.length > 0) {
                    currentPhotos = photos;
                    currentPhotoIndex = 0;
                    displayPhotos(destination, photos);
                    startPhotoCycle();
                }
            } catch (error) {
                debugLog('Error fetching photos', error);
            }
        }

        function displayPhotos(destination, photos) {
            photoGallery.innerHTML = '';
            photos.forEach((photo, index) => {
                const photoCard = document.createElement('div');
                photoCard.className = `photo-card ${index === 0 ? 'active' : ''}`;
                photoCard.innerHTML = `
                    <img src="${photo.thumb}" alt="${photo.alt}" class="w-full h-56 object-cover">
                    <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 via-black/50 to-transparent text-white p-3">
                        <p class="text-sm font-bold">${destination}</p>
                        <p class="text-xs opacity-90">Photo by <a href="${photo.photographer_url}" target="_blank" class="underline hover:text-blue-300">${photo.photographer}</a></p>
                    </div>
                `;
                photoGallery.appendChild(photoCard);
            });

            // Slide avatar left and show gallery
            avatarContainer.classList.add('avatar-slide-left');

            // Small delay to ensure avatar animation starts first
            setTimeout(() => {
                photoGallery.classList.add('active');
            }, 200);
        }

        function startPhotoCycle() {
            let photosShown = 0;
            const maxPhotos = Math.min(currentPhotos.length, 5);

            photoCycleInterval = setInterval(() => {
                const photoCards = photoGallery.querySelectorAll('.photo-card');
                if (currentPhotoIndex >= photoCards.length) currentPhotoIndex = 0;

                photoCards.forEach((card, index) => {
                    card.classList.toggle('active', index === currentPhotoIndex);
                });

                currentPhotoIndex++;
                photosShown++;

                if (photosShown >= maxPhotos) {
                    clearPhotoCycle();
                    photoDisplayTimeout = setTimeout(() => {
                        resetGallery();
                    }, 1000);
                }
            }, 6000);
        }

        function clearPhotoCycle() {
            if (photoCycleInterval) {
                clearInterval(photoCycleInterval);
                photoCycleInterval = null;
            }
            if (photoDisplayTimeout) {
                clearTimeout(photoDisplayTimeout);
                photoDisplayTimeout = null;
            }
        }

        function resetGallery() {
            photoGallery.classList.remove('active');
            setTimeout(() => {
                avatarContainer.classList.remove('avatar-slide-left');
                setTimeout(() => {
                    photoGallery.innerHTML = '';
                    currentPhotos = [];
                    currentPhotoIndex = 0;
                    currentDestinations.clear();
                }, 400);
            }, 400);
        }

        function setAvatarSpeaking(speaking) {
            if (speaking && !isAssistantSpeaking) {
                isAssistantSpeaking = true;
                if (avatarImg) avatarImg.src = animatedAvatarSrc;
                debugLog("Avatar started speaking animation");
            } else if (!speaking && isAssistantSpeaking) {
                isAssistantSpeaking = false;
                if (avatarImg) avatarImg.src = staticAvatarSrc;
                debugLog("Avatar stopped speaking animation");
            }
        }

        async function setupAudioWorklets() {
            if (!audioContext) {
                audioContext = new AudioContext({ sampleRate: 16000 });
                await audioContext.resume();
            }
            await audioContext.audioWorklet.addModule('/static/js/audio-output-worklet.js');
            outputWorkletNode = new AudioWorkletNode(audioContext, 'audio-output-processor');
            outputWorkletNode.connect(audioContext.destination);
            debugLog('Audio output worklet is ready.');
            await audioContext.audioWorklet.addModule('/static/js/audio-input-worklet.js');
            micStream = await navigator.mediaDevices.getUserMedia({
                audio: {
                    sampleRate: 16000,
                    channelCount: 1,
                    echoCancellation: true,
                    noiseSuppression: true
                }
            });
            const micSourceNode = audioContext.createMediaStreamSource(micStream);
            inputWorkletNode = new AudioWorkletNode(audioContext, 'audio-input-processor');
            inputWorkletNode.port.onmessage = (event) => {
                if (socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(event.data);
                }
            };
            micSourceNode.connect(inputWorkletNode);
            debugLog('Audio input worklet is ready and listening to microphone.');
        }

        window.startCall = async function () {
            try {
                updateStatus("Connecting to Maya...", false);
                debugLog("Initiating call request");
                const res = await fetch("/make_call");
                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.detail || "Failed to create call");
                }
                const data = await res.json();
                if (!data.url) throw new Error("No WebSocket URL received");
                debugLog("Received WebSocket URL", { url: data.url });
                socket = new WebSocket(data.url);
                socket.binaryType = "arraybuffer";
                socket.onopen = async () => {
                    debugLog("WebSocket connection opened");
                    updateStatus("Setting up microphone...", true);
                    try {
                        await setupAudioWorklets();
                        updateStatus("Maya is listening... Start talking!", true);
                    } catch (micError) {
                        debugLog("Audio setup error", micError);
                        updateStatus(`Error: ${micError.message}`, false);
                        stopCall();
                    }
                };
                socket.onmessage = (event) => {
                    if (typeof event.data === "string") {
                        try {
                            const msg = JSON.parse(event.data);
                            handleJsonMessage(msg);
                        } catch (parseError) {
                            debugLog("JSON parse error", parseError);
                        }
                    } else if (event.data instanceof ArrayBuffer) {
                        if (outputWorkletNode) {
                            outputWorkletNode.port.postMessage(event.data);
                        }
                    }
                };
                socket.onerror = (error) => {
                    debugLog("WebSocket error", error);
                    updateStatus("Connection error - please try again", false);
                };
                socket.onclose = (event) => {
                    debugLog("WebSocket closed", { code: event.code, reason: event.reason });
                    updateStatus("Ready to help you plan your adventure from Mumbai", false);
                    cleanup();
                };
            } catch (error) {
                debugLog("Start call error", error);
                updateStatus(`Failed to connect: ${error.message}`, false);
            }
        }

        function handleJsonMessage(msg) {
            debugLog("Received JSON message", msg);
            switch (msg.type) {
                case 'speech-update':
                    if (msg.role === 'assistant') {
                        if (msg.status === 'started') {
                            setAvatarSpeaking(true);
                            clearTimeout(assistantSpeakingTimeout);
                        } else if (msg.status === 'stopped') {
                            clearTimeout(assistantSpeakingTimeout);
                            assistantSpeakingTimeout = setTimeout(() => {
                                setAvatarSpeaking(false);
                            }, 500);
                        }
                    }
                    break;
                case 'transcript':
                    if (msg.transcriptType === 'final' && msg.transcript) {
                        const role = msg.role === 'user' ? 'user' : 'assistant';
                        addToTranscript(role, msg.transcript);
                    }
                    break;
                case 'error':
                    debugLog("Error message received", msg);
                    updateStatus(`Error: ${msg.message || 'Unknown error'}`, false);
                    break;
                default:
                    break;
            }
        }

        window.stopCall = function () {
            debugLog("Stopping call");
            if (socket) {
                if (socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({ type: "hangup" }));
                }
                socket.close();
            }
            cleanup();
            updateStatus("Ready to help you plan your adventure from Mumbai", false);
            setAvatarSpeaking(false);
            clearTimeout(assistantSpeakingTimeout);
            clearPhotoCycle();
            resetGallery();

            // Reset map state
            hideMap();
            mapToggleBtn.disabled = true;
            firstDestinationAdded = false;
        }

        function cleanup() {
            if (micStream) {
                micStream.getTracks().forEach(track => track.stop());
                micStream = null;
                debugLog("Microphone stream stopped.");
            }
            if (inputWorkletNode) {
                inputWorkletNode.disconnect();
                inputWorkletNode = null;
            }
            if (outputWorkletNode) {
                outputWorkletNode.disconnect();
                outputWorkletNode = null;
            }
            if (audioContext && audioContext.state !== 'closed') {
                audioContext.close().then(() => {
                    audioContext = null;
                    debugLog("AudioContext closed.");
                });
            }
            socket = null;
            isAssistantSpeaking = false;
            debugLog("Cleanup completed");
        }

        // Global functions
        window.clearRoute = clearRoute;
        window.hideMap = hideMap;
        window.toggleMap = toggleMap;
        window.startCall = startCall;
        window.stopCall = stopCall;
        window.toggleDebug = toggleDebug;
    </script>
</body>

</html>